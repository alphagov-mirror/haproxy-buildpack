#!/bin/bash
# bin/compile <build-dir> <cache-dir>

set -ex

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
IDX=$4
VERSION_DIR=`cd $(dirname $0); cd ..; pwd`
VERSION=`cat $VERSION_DIR/VERSION | sed 's/[\r\n]*$//'`
ARCHIVE=`basename $VERSION`
ARCHIVE_DIR=`echo $ARCHIVE | sed 's/\.tar\.gz$//'`

get_source() {
  if [ ! -d $CACHE_DIR ]; then
    echo "Creating $CACHE_DIR"
    mkdir $CACHE_DIR
  fi


  if [ -e $CACHE_DIR/$ARCHIVE ]; then
    echo "Don't need to download, already exists"
  else
    echo "Downloading $VERSION..."
    curl -L $VERSION -o $CACHE_DIR/$ARCHIVE
  fi
}

unpack_source() {
  if [ ! -d $CACHE_DIR/$ARCHIVE_DIR ]; then
    echo "Unpacking..."
    `tar xzf $CACHE_DIR/$ARCHIVE -C $CACHE_DIR`
  fi
}

compile_source() {
  unpack_source
  if [ ! -f $CACHE_DIR/$ARCHIVE_DIR/haproxy ]; then
    echo "Compiling $ARCHIVE_DIR..."
    cd $CACHE_DIR/$ARCHIVE_DIR
    make TARGET="linux-glibc" EXTRA_OBJS="contrib/prometheus-exporter/service-prometheus.o" USE_OPENSSL=1
  fi
  cp $CACHE_DIR/$ARCHIVE_DIR/haproxy $DEPS_DIR/$IDX
}

add_to_path() {
  echo "Adding haproxy to \$PATH"
  mkdir -p $DEPS_DIR/$IDX/profile.d
  cat <<-EOF > $DEPS_DIR/$IDX/profile.d/add-to-path.sh
  export PATH=$PATH:\$DEPS_DIR/\$IDX
  echo "Added haproxy to path \$PATH"
EOF
}

get_source
compile_source
add_to_path

echo "-----> Done."

exit 0
